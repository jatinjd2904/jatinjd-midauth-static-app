<!DOCTYPE html>
<html>
<head>
  <title>Jatin Mid-Auth Widget Test</title>
  <!-- MSAL.js library -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
</head>
<body>
  <h1>Jatin App - Mid-Auth Chat Widget</h1>

  <!-- Auth buttons -->
  <button onclick="login()">Sign in with Azure AD</button>
  <button onclick="logout()">Sign out</button>

  <pre id="user"></pre>

  <div style="background: #e3f2fd; padding: 15px; margin: 20px 0; border-left: 4px solid #2196f3;">
    <strong>This page supports both authenticated and unauthenticated chat.</strong>
    <br>Sign in to chat as an authenticated user, or use anonymously without signing in.
    <br>For fully authenticated chat only, visit <a href="index.html" style="color: #0066cc; text-decoration: underline;">index.html</a>
  </div>

  <!-- Chat Widget Configuration Section -->
  <hr style="margin: 30px 0;">
  <h2>Configure Chat Widget (Mid-Auth - Optional Authentication)</h2>

  <div style="background: #f5f5f5; padding: 20px; margin-bottom: 20px;">
    <h3>Widget Configuration</h3>
    <form id="widget-config">
      <label>App ID: <input type="text" id="widget-appId" value="50fbd2aa-1a19-475f-aeb6-59c8d15c8387" style="width: 300px;"></label><br><br>
      <label>Org ID: <input type="text" id="widget-orgId" value="1e9d7bbe-facf-f011-8537-000d3a59231e" style="width: 300px;"></label><br><br>
      <label>Org URL: <input type="text" id="widget-orgUrl" value="https://m-1e9d7bbe-facf-f011-8537-000d3a59231e.preprod.omnichannelengagementhub.com" style="width: 500px;"></label><br><br>
      <label>Script URL: <input type="text" id="widget-scriptUrl" value="https://msft-lcw-trial.azureedge.net/jatinjdd/0123/v2scripts/LiveChatBootstrapper.js" style="width: 500px;"></label><br><br>
      <button type="button" onclick="loadWidget()">Load Widget</button>
      <button type="button" onclick="removeWidget()">Remove Widget</button>
      <button type="button" onclick="hardReload()" style="background-color: #ff9800; color: white;">Remove & Clear All Cache</button>
    </form>
  </div>

  <div id="widget-status" style="background: #e8f5e9; padding: 15px; margin-bottom: 20px; display: none;">
    <h3>Widget Status:</h3>
    <pre id="widget-status-text"></pre>
  </div>
  <hr style="margin: 30px 0;">

  <script>
    // MSAL Configuration
    const msalConfig = {
      auth: {
        clientId: "b0565fdb-6754-40e3-9446-72afdf056f0b",
        authority: "https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47",
        redirectUri: window.location.origin + "/widget2.html"
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false
      }
    };

    // Scopes for token request
    const tokenRequest = {
      scopes: ["b0565fdb-6754-40e3-9446-72afdf056f0b/.default"]
    };

    // Initialize MSAL
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    // Store the access token and expiration time globally
    let currentAccessToken = null;
    let tokenExpiresOn = null;

    // ⚠️ NEW: Track pending mid-auth token and chat restoration state
    let pendingMidAuthToken = null;
    let chatRestored = false;

    // Check if token is expired or will expire soon (within 5 minutes)
    function isTokenExpired() {
      if (!tokenExpiresOn) return true;
      const now = new Date();
      const expiryTime = new Date(tokenExpiresOn);
      const timeUntilExpiry = expiryTime - now;
      const fiveMinutes = 5 * 60 * 1000;
      return timeUntilExpiry < fiveMinutes;
    }

    // Refresh the access token
    async function refreshToken() {
      console.log('Refreshing access token...');
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length === 0) {
        console.error('No accounts found for token refresh');
        return null;
      }

      const request = {
        ...tokenRequest,
        account: accounts[0]
      };

      try {
        const response = await msalInstance.acquireTokenSilent(request);
        currentAccessToken = response.accessToken;
        tokenExpiresOn = response.expiresOn;
        console.log('Token refreshed successfully');
        console.log('New token expires:', new Date(tokenExpiresOn));
        return currentAccessToken;
      } catch (error) {
        console.error('Token refresh failed:', error);
        await msalInstance.acquireTokenRedirect(request);
        return null;
      }
    }

    // Define window.auth.getAuthenticationToken for Omnichannel authenticated chat
    window.auth = {};
    window.auth.getAuthenticationToken = async function(callback) {
      console.log('window.auth.getAuthenticationToken() called by Omnichannel widget');

      try {
        if (currentAccessToken && !isTokenExpired()) {
          console.log('Returning cached AAD access token:', currentAccessToken);
          callback(currentAccessToken);
        } else if (currentAccessToken && isTokenExpired()) {
          console.log('Token expired or expiring soon, refreshing...');
          const newToken = await refreshToken();
          if (newToken) {
            callback(newToken);
          } else {
            console.error('Token refresh failed');
            callback(null);
          }
        } else {
          console.error('No access token available. User may not be logged in.');
          callback(null);
        }
      } catch (error) {
        console.error('Error in getAuthenticationToken:', error);
        callback(null);
      }
    };

    // Function to send mid-auth token to widget
    function sendMidAuthToken() {
      if (!widgetLoaded) {
        console.warn('[MidAuth] Widget is not loaded yet');
        return false;
      }

      const tokenToSend = pendingMidAuthToken || currentAccessToken;

      if (!tokenToSend || isTokenExpired()) {
        console.warn('[MidAuth] No valid access token available');
        return false;
      }

      try {
        if (window.Microsoft && window.Microsoft.Omnichannel &&
            window.Microsoft.Omnichannel.LiveChatWidget &&
            window.Microsoft.Omnichannel.LiveChatWidget.SDK) {

          console.log('[MidAuth] Calling Microsoft.Omnichannel.LiveChatWidget.SDK.setMidAuthToken()');
          console.log('[MidAuth] Token (first 50 chars):', tokenToSend.substring(0, 50) + '...');
          window.Microsoft.Omnichannel.LiveChatWidget.SDK.setMidAuthToken(tokenToSend);
          console.log('[MidAuth] ✅ Mid-auth token set successfully');

          // Clear pending token after successful send
          pendingMidAuthToken = null;
          return true;

        } else {
          console.error('[MidAuth] LiveChatWidget SDK not available');
          return false;
        }
      } catch (error) {
        console.error('[MidAuth] Error setting mid-auth token:', error);
        return false;
      }
    }

    // Login function
    async function login() {
      try {
        console.log('Initiating MSAL login redirect...');
        await msalInstance.loginRedirect(tokenRequest);
      } catch (error) {
        console.error('Login failed:', error);
        alert('Login failed: ' + error.message);
      }
    }

    // Get access token
    async function getToken() {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length === 0) {
        console.error('No accounts found');
        return;
      }

      const request = {
        ...tokenRequest,
        account: accounts[0]
      };

      try {
        const response = await msalInstance.acquireTokenSilent(request);
        currentAccessToken = response.accessToken;
        tokenExpiresOn = response.expiresOn;

        console.log('AAD Access Token acquired:', currentAccessToken);
        console.log('Token length:', currentAccessToken.length);
        console.log('Token expires:', new Date(tokenExpiresOn));

        displayUserInfo(response.account, currentAccessToken);

        setTimeout(function() {
          console.log('Testing window.auth.getAuthenticationToken...');
          window.auth.getAuthenticationToken(function(token) {
            if (token) {
              console.log('Test successful - Token retrieved:', token);
            } else {
              console.error('Test failed: No token returned');
            }
          });

          // Store as pending - will be sent when chat is ready/restored
          if (widgetLoaded) {
            console.log('[MidAuth] Widget loaded - storing pending token');
            pendingMidAuthToken = currentAccessToken;

            // Check if chat already restored (race condition)
            if (chatRestored) {
              console.log('[MidAuth] Chat already restored - sending token now');
              sendMidAuthToken();
            } else {
              console.log('[MidAuth] Waiting for chat to restore from cache...');
            }
          } else {
            console.log('[MidAuth] Widget not loaded yet - token will be used when widget loads');
          }
        }, 500);

      } catch (error) {
        console.error('Silent token acquisition failed, using redirect:', error);
        await msalInstance.acquireTokenRedirect(request);
      }
    }

    // Display user info
    function displayUserInfo(account, token) {
      const userInfo = {
        username: account.username,
        name: account.name,
        accountId: account.homeAccountId,
        tenantId: account.tenantId
      };

      document.getElementById("user").innerHTML =
        '<h3>User Info:</h3><pre style="background:#e8f5e9;padding:10px;">' +
        JSON.stringify(userInfo, null, 2) +
        '</pre>' +
        '<h3>Access Token (Real AAD JWT):</h3><pre style="background:#f0f0f0;padding:10px;word-wrap:break-word;font-size:11px;">' +
        token +
        '</pre>';
    }

    // Logout function
    function logout() {
      currentAccessToken = null;
      tokenExpiresOn = null;
      pendingMidAuthToken = null;
      chatRestored = false;
      document.getElementById("user").innerHTML = '';
      const logoutRequest = {
        account: msalInstance.getAllAccounts()[0]
      };
      msalInstance.logoutRedirect(logoutRequest);
    }

    // Check if user is already logged in on page load
    msalInstance.handleRedirectPromise()
      .then(response => {
        if (response) {
          console.log('Redirect response:', response);
          console.log('Login successful via redirect');
          currentAccessToken = response.accessToken;
          tokenExpiresOn = response.expiresOn;
          console.log('AAD Access Token acquired:', currentAccessToken);
          console.log('Token length:', currentAccessToken.length);
          console.log('Token expires:', new Date(tokenExpiresOn));
          displayUserInfo(response.account, currentAccessToken);

          // ⚠️ CRITICAL FIX: Don't send token immediately after redirect
          // Store it as pending and wait for widget to restore chat context
          console.log('[MidAuth] Token acquired after redirect - storing as pending');
          pendingMidAuthToken = currentAccessToken;

          // Check if widget already loaded and chat restored (race condition)
          if (widgetLoaded && chatRestored) {
            console.log('[MidAuth] Widget and chat already ready - sending token now');
            setTimeout(() => sendMidAuthToken(), 500);
          } else if (widgetLoaded) {
            console.log('[MidAuth] Widget loaded - waiting for chat to restore...');
          } else {
            console.log('[MidAuth] Widget not loaded yet - will send token when ready');
          }

        } else {
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length > 0) {
            console.log('User already logged in');
            getToken();
          }
        }
      })
      .catch(error => {
        console.error('Error handling redirect:', error);
      });

    // Widget Management Functions
    let widgetLoaded = false;

    function loadWidget() {
      const appId = document.getElementById('widget-appId').value;
      const orgId = document.getElementById('widget-orgId').value;
      const orgUrl = document.getElementById('widget-orgUrl').value;
      const scriptUrl = document.getElementById('widget-scriptUrl').value;

      console.log('loadWidget() called with:', { appId, orgId, orgUrl, scriptUrl });

      if (!appId || !orgId || !orgUrl || !scriptUrl) {
        showWidgetStatus('All fields are required');
        console.error('Validation failed - missing required fields');
        return;
      }

      if (widgetLoaded) {
        showWidgetStatus('Widget is already loaded. Remove it first to reload.');
        return;
      }

      const script = document.createElement('script');
      script.id = 'Microsoft_Omnichannel_LCWidget';

      script.setAttribute('data-app-id', appId);
      script.setAttribute('data-lcw-version', 'test');
      script.setAttribute('data-org-id', orgId);
      script.setAttribute('data-org-url', orgUrl);

      console.log('Script element created with ID:', script.id);
      console.log('Data attributes set:', {
        'data-app-id': script.getAttribute('data-app-id'),
        'data-org-id': script.getAttribute('data-org-id'),
        'data-org-url': script.getAttribute('data-org-url'),
        'data-lcw-version': script.getAttribute('data-lcw-version')
      });

      const cacheBuster = new Date().getTime();
      const separator = scriptUrl.includes('?') ? '&' : '?';
      script.src = scriptUrl + separator + 'cb=' + cacheBuster;

      console.log('Widget script URL with cache-buster:', script.src);

      document.body.appendChild(script);
      widgetLoaded = true;

      console.log('Widget script appended to document body');
      console.log('Widget loaded:', { appId, orgId, orgUrl });
      showWidgetStatus(`Widget loaded successfully!\nApp ID: ${appId}\nOrg ID: ${orgId}`);

      setupMidAuthTokenListener();
    }

    // ⚠️ UPDATED: Set up listeners for chat restoration and mid-auth token passing
    function setupMidAuthTokenListener() {
      console.log('[MidAuth] Setting up event listeners...');

      window.addEventListener('lcw:ready', function() {
        console.log('[MidAuth] lcw:ready event received - widget is ready');
      });

      // ⚠️ KEY FIX: Listen for chat restoration from cache
      window.addEventListener('message', function(event) {
        if (event.data && event.data.eventName === 'ChatRetrievedFromCache') {
          console.log('[MidAuth] *** CHAT RESTORED FROM CACHE ***');
          console.log('[MidAuth] Chat details:', {
            chatId: event.data.payload?.chatId,
            requestId: event.data.payload?.requestId
          });

          chatRestored = true;

          if (pendingMidAuthToken && !isTokenExpired()) {
            console.log('[MidAuth] Sending pending token to restored chat...');
            setTimeout(() => {
              const success = sendMidAuthToken();
              if (success) {
                console.log('[MidAuth] ✅ Token sent to restored chat - should trigger mid-auth!');
                alert('✅ Authentication successful! Your chat is now authenticated.');
              } else {
                console.error('[MidAuth] ❌ Failed to send token to restored chat');
              }
            }, 1000);
          } else if (currentAccessToken && !isTokenExpired()) {
            console.log('[MidAuth] Using current token for restored chat');
            pendingMidAuthToken = currentAccessToken;
            setTimeout(() => sendMidAuthToken(), 1000);
          } else {
            console.log('[MidAuth] No valid token available for restored chat');
          }
        }
      });

      console.log('[MidAuth] Event listeners registered');
    }

    function removeWidget() {
      const script = document.getElementById('Microsoft_Omnichannel_LCWidget');

      console.log('Removing widget...');

      const iframes = document.querySelectorAll('iframe');
      iframes.forEach(iframe => {
        if (iframe.src && (iframe.src.includes('omnichannelengagementhub') ||
            iframe.src.includes('livechat') ||
            iframe.src.includes('lcw') ||
            iframe.id.includes('lcw') ||
            iframe.className.includes('lcw'))) {
          console.log('Removing widget iframe:', iframe.src);
          iframe.remove();
        }
      });
      console.log('All widget iframes removed');

      let removedCount = 0;

      const ocElements = document.querySelectorAll('[class*="oc-lcw"], [id*="oc-lcw"]');
      ocElements.forEach(el => {
        el.remove();
        removedCount++;
      });
      console.log(`Removed ${removedCount} widget DOM elements`);

      const omnichannelElements = document.querySelectorAll('[class*="microsoft-omnichannel"], [id*="microsoft-omnichannel"]');
      omnichannelElements.forEach(el => {
        el.remove();
      });

      if (script) {
        script.remove();
        console.log('Widget script removed');
      }

      try {
        const localStorageKeys = Object.keys(localStorage);
        let localStorageCleanedCount = 0;
        localStorageKeys.forEach(key => {
          if (key.startsWith('oc-lcw-') ||
              key.includes('Omnichannel') ||
              key.includes('livechat') ||
              key.includes('reconnectId') ||
              key.includes('chatToken')) {
            localStorage.removeItem(key);
            localStorageCleanedCount++;
            console.log('Removed localStorage key:', key);
          }
        });
        console.log(`Cleaned up ${localStorageCleanedCount} localStorage items`);
      } catch (e) {
        console.warn('Could not clean up localStorage:', e);
      }

      try {
        const sessionStorageKeys = Object.keys(sessionStorage);
        let sessionStorageCleanedCount = 0;
        sessionStorageKeys.forEach(key => {
          if (key.startsWith('oc-lcw-') ||
              key.includes('Omnichannel') ||
              key.includes('livechat') ||
              key.includes('reconnectId') ||
              key.includes('chatToken')) {
            sessionStorage.removeItem(key);
            sessionStorageCleanedCount++;
            console.log('Removed sessionStorage key:', key);
          }
        });
        console.log(`Cleaned up ${sessionStorageCleanedCount} sessionStorage items`);
      } catch (e) {
        console.warn('Could not clean up sessionStorage:', e);
      }

      try {
        if (window.Microsoft && window.Microsoft.Omnichannel) {
          delete window.Microsoft.Omnichannel.LiveChatWidget;
          console.log('Cleaned up window.Microsoft.Omnichannel.LiveChatWidget');
        }
        if (window.Microsoft && window.Microsoft.Omnichannel && Object.keys(window.Microsoft.Omnichannel).length === 0) {
          delete window.Microsoft.Omnichannel;
          console.log('Cleaned up window.Microsoft.Omnichannel');
        }
        if (window.Microsoft && Object.keys(window.Microsoft).length === 0) {
          delete window.Microsoft;
          console.log('Cleaned up window.Microsoft');
        }
      } catch (e) {
        console.warn('Could not clean up global objects:', e);
      }

      widgetLoaded = false;
      chatRestored = false;
      pendingMidAuthToken = null;
      showWidgetStatus('Widget removed successfully. You can now load a different widget configuration.');
      console.log('Widget cleanup complete');
    }

    async function hardReload() {
      console.log('Performing hard reload with cache clear...');

      const formData = {
        appId: document.getElementById('widget-appId').value,
        orgId: document.getElementById('widget-orgId').value,
        orgUrl: document.getElementById('widget-orgUrl').value,
        scriptUrl: document.getElementById('widget-scriptUrl').value
      };
      localStorage.setItem('widget-config-saved', JSON.stringify(formData));
      console.log('Saved form values:', formData);

      removeWidget();

      if ('caches' in window) {
        try {
          const cacheNames = await caches.keys();
          console.log('Clearing', cacheNames.length, 'cache(s):', cacheNames);
          await Promise.all(cacheNames.map(cacheName => caches.delete(cacheName)));
          console.log('All service worker caches cleared');
        } catch (e) {
          console.warn('Could not clear service worker caches:', e);
        }
      }

      setTimeout(() => {
        console.log('Performing hard reload (Ctrl+Shift+R equivalent)');
        window.location.reload(true);
      }, 500);
    }

    function showWidgetStatus(message) {
      const statusDiv = document.getElementById('widget-status');
      const statusText = document.getElementById('widget-status-text');
      statusDiv.style.display = 'block';
      statusText.textContent = message;

      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    function saveCurrentFormValues() {
      const formData = {
        appId: document.getElementById('widget-appId').value,
        orgId: document.getElementById('widget-orgId').value,
        orgUrl: document.getElementById('widget-orgUrl').value,
        scriptUrl: document.getElementById('widget-scriptUrl').value
      };
      localStorage.setItem('widget-config-current', JSON.stringify(formData));
      console.log('Form values saved to localStorage');
    }

    function restoreSavedConfig() {
      const hardReloadConfig = localStorage.getItem('widget-config-saved');
      if (hardReloadConfig) {
        try {
          const formData = JSON.parse(hardReloadConfig);
          console.log('Restoring form values from hard reload:', formData);

          document.getElementById('widget-appId').value = formData.appId;
          document.getElementById('widget-orgId').value = formData.orgId;
          document.getElementById('widget-orgUrl').value = formData.orgUrl;
          document.getElementById('widget-scriptUrl').value = formData.scriptUrl;

          localStorage.removeItem('widget-config-saved');
          console.log('Hard reload config restored and removed');
          return;
        } catch (e) {
          console.error('Could not restore hard reload config:', e);
        }
      }

      const savedConfig = localStorage.getItem('widget-config-current');
      if (savedConfig) {
        try {
          const formData = JSON.parse(savedConfig);
          console.log('Restoring form values from last page state:', formData);

          document.getElementById('widget-appId').value = formData.appId;
          document.getElementById('widget-orgId').value = formData.orgId;
          document.getElementById('widget-orgUrl').value = formData.orgUrl;
          document.getElementById('widget-scriptUrl').value = formData.scriptUrl;

          console.log('Form values restored successfully');
        } catch (e) {
          console.error('Could not restore saved config:', e);
        }
      }
    }

    function setupFormAutoSave() {
      const inputs = ['widget-appId', 'widget-orgId', 'widget-orgUrl', 'widget-scriptUrl'];
      inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.addEventListener('change', saveCurrentFormValues);
          input.addEventListener('input', saveCurrentFormValues);
        }
      });
      console.log('Form auto-save enabled');
    }

    window.addEventListener('beforeunload', () => {
      saveCurrentFormValues();
    });

    window.addEventListener('DOMContentLoaded', () => {
      restoreSavedConfig();
      setupFormAutoSave();
    });
  </script>
</body>
</html>
