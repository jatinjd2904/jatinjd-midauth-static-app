<!DOCTYPE html>
<html>
<head>
  <title>Jatin UnAuth Widget Test</title>
  <!-- MSAL.js library for optional user context detection -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
</head>
<body>
  <h1>Jatin App - Unauthenticated Chat Widget</h1>

  <div style="background: #e3f2fd; padding: 15px; margin: 20px 0; border-left: 4px solid #2196f3;">
    <strong>This page uses unauthenticated chat (no token validation).</strong>
    <br>If logged into Azure AD, your name will appear to the agent.
    <br>For fully authenticated chat with token validation, visit <a href="index.html" style="color: #0066cc; text-decoration: underline;">index.html</a>
  </div>

  <!-- Optional Login Section -->
  <div style="background: #fff3cd; padding: 15px; margin: 20px 0; border-left: 4px solid #ffc107;">
    <strong>Optional:</strong> Sign in to pass your name to the agent (chat remains unauthenticated)
    <br><br>
    <button onclick="login()" id="loginBtn">Sign in with Azure AD</button>
    <button onclick="logout()" id="logoutBtn" style="display:none;">Sign out</button>
    <pre id="user" style="margin-top: 10px;"></pre>
  </div>

  <!-- Chat Widget Configuration Section -->
  <hr style="margin: 30px 0;">
  <h2>Configure Chat Widget (UnAuth - No Authentication)</h2>

  <div style="background: #f5f5f5; padding: 20px; margin-bottom: 20px;">
    <h3>Widget Configuration</h3>
    <form id="widget-config">
      <label>App ID: <input type="text" id="widget-appId" value="50fbd2aa-1a19-475f-aeb6-59c8d15c8387" style="width: 300px;"></label><br><br>
      <label>Org ID: <input type="text" id="widget-orgId" value="1e9d7bbe-facf-f011-8537-000d3a59231e" style="width: 300px;"></label><br><br>
      <label>Org URL: <input type="text" id="widget-orgUrl" value="https://m-1e9d7bbe-facf-f011-8537-000d3a59231e.preprod.omnichannelengagementhub.com" style="width: 500px;"></label><br><br>
      <label>Script URL: <input type="text" id="widget-scriptUrl" value="https://msft-lcw-trial.azureedge.net/jatinjdd/0123/v2scripts/LiveChatBootstrapper.js" style="width: 500px;"></label><br><br>
      <button type="button" onclick="loadWidget()">Load Widget</button>
      <button type="button" onclick="removeWidget()">Remove Widget</button>
    </form>
  </div>

  <div id="widget-status" style="background: #e8f5e9; padding: 15px; margin-bottom: 20px; display: none;">
    <h3>Widget Status:</h3>
    <pre id="widget-status-text"></pre>
  </div>
  <hr style="margin: 30px 0;">

  <script>
    // MSAL Configuration for optional user context
    const msalConfig = {
      auth: {
        clientId: "b0565fdb-6754-40e3-9446-72afdf056f0b",
        authority: "https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47",
        redirectUri: window.location.origin + "/widget2.html"
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false
      }
    };

    const tokenRequest = {
      scopes: ["User.Read"] // Only need basic profile info, not app-specific token
    };

    // Initialize MSAL
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    // Store user info
    let currentUser = null;

    // Login function
    async function login() {
      try {
        console.log('Initiating MSAL login redirect...');
        await msalInstance.loginRedirect(tokenRequest);
      } catch (error) {
        console.error('Login failed:', error);
        alert('Login failed: ' + error.message);
      }
    }

    // Logout function
    function logout() {
      currentUser = null;
      const logoutRequest = {
        account: msalInstance.getAllAccounts()[0]
      };
      msalInstance.logoutRedirect(logoutRequest);
    }

    // Get user info from MSAL
    async function getUserInfo() {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length === 0) {
        console.log('No user logged in');
        return null;
      }

      const account = accounts[0];
      console.log('User logged in:', account.name, account.username);

      return {
        name: account.name,
        email: account.username
      };
    }

    // Display user info
    function displayUserInfo(account) {
      const userInfo = {
        name: account.name,
        email: account.username
      };

      document.getElementById("user").innerHTML =
        '<strong>Logged in as:</strong><br>' +
        JSON.stringify(userInfo, null, 2);

      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'inline-block';
    }

    // Setup context provider globally BEFORE widget loads
    // This is the Power Pages pattern - context must be available during widget initialization
    function setupContextProvider() {
      console.log('Setting up context provider for widget');

      // Method 1: Direct window function (some widgets call this)
      window.getOmnichannelContextProvider = function() {
        console.log('Widget calling getOmnichannelContextProvider, currentUser:', currentUser);

        if (currentUser && currentUser.name) {
          return {
            'Customer Name': { value: currentUser.name, isDisplayable: true },
            'Customer Email': { value: currentUser.email || 'Unknown', isDisplayable: true },
            'Logged In': { value: 'Yes (Context Only)', isDisplayable: true }
          };
        } else {
          return {};
        }
      };

      // Method 2: Listen for lcw:ready event and set context then
      window.addEventListener('lcw:ready', function() {
        console.log('Widget lcw:ready event fired');

        if (window.Microsoft && window.Microsoft.Omnichannel &&
            window.Microsoft.Omnichannel.LiveChatWidget &&
            window.Microsoft.Omnichannel.LiveChatWidget.SDK) {

          console.log('Setting context via SDK after lcw:ready');

          Microsoft.Omnichannel.LiveChatWidget.SDK.setContextProvider(function() {
            console.log('SDK Context provider called, currentUser:', currentUser);

            if (currentUser && currentUser.name) {
              return {
                'Customer Name': { value: currentUser.name, isDisplayable: true },
                'Customer Email': { value: currentUser.email || 'Unknown', isDisplayable: true }
              };
            }
            return {};
          });
        }
      });

      console.log('Context provider function registered globally');
    }

    // Set widget context after widget loads (legacy approach as backup)
    function setWidgetContextLegacy(userInfo) {
      if (!userInfo) {
        console.log('No user info for legacy context setting');
        return;
      }

      console.log('Attempting legacy context provider setup');

      // Wait for widget SDK to be available
      const checkWidget = setInterval(() => {
        if (window.Microsoft && window.Microsoft.Omnichannel && window.Microsoft.Omnichannel.LiveChatWidget &&
            window.Microsoft.Omnichannel.LiveChatWidget.SDK) {
          clearInterval(checkWidget);

          try {
            // Set context provider using SDK method
            Microsoft.Omnichannel.LiveChatWidget.SDK.setContextProvider(function() {
              console.log('Legacy context provider called');
              return {
                'Customer Name': { value: userInfo.name || 'Unknown', isDisplayable: true },
                'Customer Email': { value: userInfo.email || 'Unknown', isDisplayable: true }
              };
            });

            console.log('Legacy widget context set successfully');
          } catch (error) {
            console.error('Failed to set legacy widget context:', error);
          }
        }
      }, 500);

      // Stop checking after 10 seconds
      setTimeout(() => clearInterval(checkWidget), 10000);
    }

    // Check if user is already logged in on page load
    msalInstance.handleRedirectPromise()
      .then(async response => {
        if (response) {
          console.log('Login successful via redirect');
          currentUser = {
            name: response.account.name,
            email: response.account.username
          };
          displayUserInfo(response.account);
        } else {
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length > 0) {
            console.log('User already logged in');
            currentUser = {
              name: accounts[0].name,
              email: accounts[0].username
            };
            displayUserInfo(accounts[0]);
          }
        }
      })
      .catch(error => {
        console.error('Error handling redirect:', error);
      });

    // Widget Management Functions
    let widgetLoaded = false;

    function loadWidget() {
      const appId = document.getElementById('widget-appId').value;
      const orgId = document.getElementById('widget-orgId').value;
      const orgUrl = document.getElementById('widget-orgUrl').value;
      const scriptUrl = document.getElementById('widget-scriptUrl').value;

      console.log('loadWidget() called with:', { appId, orgId, orgUrl, scriptUrl });
      console.log('Current user state:', currentUser);

      // Validate inputs
      if (!appId || !orgId || !orgUrl || !scriptUrl) {
        showWidgetStatus('All fields are required');
        console.error('Validation failed - missing required fields');
        return;
      }

      // Check if already loaded
      if (widgetLoaded) {
        showWidgetStatus('Widget is already loaded. Remove it first to reload.');
        return;
      }

      // CRITICAL: Setup context provider BEFORE loading widget script
      // This ensures context is available during widget initialization
      setupContextProvider();

      // Create script element with standard ID
      const script = document.createElement('script');
      script.id = 'Microsoft_Omnichannel_LCWidget';

      // IMPORTANT: Set all data attributes BEFORE setting src
      // This ensures attributes are available when the script loads
      script.setAttribute('data-app-id', appId);
      script.setAttribute('data-lcw-version', 'test');
      script.setAttribute('data-org-id', orgId);
      script.setAttribute('data-org-url', orgUrl);

      console.log('Script element created with ID:', script.id);
      console.log('Data attributes set:', {
        'data-app-id': script.getAttribute('data-app-id'),
        'data-org-id': script.getAttribute('data-org-id'),
        'data-org-url': script.getAttribute('data-org-url'),
        'data-lcw-version': script.getAttribute('data-lcw-version')
      });

      // Set src LAST to trigger loading only after all attributes are set
      script.src = scriptUrl;

      // Add to document
      document.body.appendChild(script);
      widgetLoaded = true;

      console.log('Widget script appended to document body');
      console.log('Widget loaded:', { appId, orgId, orgUrl });
      showWidgetStatus(`Widget loaded successfully!\nApp ID: ${appId}\nOrg ID: ${orgId}`);

      // Also try legacy context provider method as backup
      if (currentUser) {
        console.log('User is logged in, attempting legacy context setup...');
        setWidgetContextLegacy(currentUser);
      } else {
        console.log('No user logged in, widget will be anonymous');
      }
    }

    function removeWidget() {
      const script = document.getElementById('Microsoft_Omnichannel_LCWidget');

      console.log('Removing widget...');

      // Remove all widget-related DOM elements (comprehensive cleanup)
      let removedCount = 0;

      // Remove all elements with oc-lcw class prefix
      const ocElements = document.querySelectorAll('[class*="oc-lcw"], [id*="oc-lcw"]');
      ocElements.forEach(el => {
        el.remove();
        removedCount++;
      });
      console.log(`Removed ${removedCount} widget DOM elements`);

      // Remove all Microsoft.Omnichannel related elements
      const omnichannelElements = document.querySelectorAll('[class*="microsoft-omnichannel"], [id*="microsoft-omnichannel"]');
      omnichannelElements.forEach(el => {
        el.remove();
      });

      // Remove the script element
      if (script) {
        script.remove();
        console.log('Widget script removed');
      }

      // Clean up global window objects created by the widget
      try {
        if (window.Microsoft && window.Microsoft.Omnichannel) {
          delete window.Microsoft.Omnichannel.LiveChatWidget;
          console.log('Cleaned up window.Microsoft.Omnichannel.LiveChatWidget');
        }
        if (window.Microsoft && window.Microsoft.Omnichannel && Object.keys(window.Microsoft.Omnichannel).length === 0) {
          delete window.Microsoft.Omnichannel;
          console.log('Cleaned up window.Microsoft.Omnichannel');
        }
        if (window.Microsoft && Object.keys(window.Microsoft).length === 0) {
          delete window.Microsoft;
          console.log('Cleaned up window.Microsoft');
        }
      } catch (e) {
        console.warn('Could not clean up global objects:', e);
      }

      widgetLoaded = false;
      showWidgetStatus('Widget removed successfully');
      console.log('Widget cleanup complete');
    }

    function showWidgetStatus(message) {
      const statusDiv = document.getElementById('widget-status');
      const statusText = document.getElementById('widget-status-text');
      statusDiv.style.display = 'block';
      statusText.textContent = message;

      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    // Parse URL parameters and populate widget configuration
    function loadConfigFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);

      // Widget parameters
      if (urlParams.has('appId')) {
        document.getElementById('widget-appId').value = urlParams.get('appId');
      }
      if (urlParams.has('orgId')) {
        document.getElementById('widget-orgId').value = urlParams.get('orgId');
      }
      if (urlParams.has('orgUrl')) {
        document.getElementById('widget-orgUrl').value = urlParams.get('orgUrl');
      }
      if (urlParams.has('scriptUrl')) {
        document.getElementById('widget-scriptUrl').value = urlParams.get('scriptUrl');
      }

      // Setup context provider BEFORE auto-loading widget
      setupContextProvider();

      // Auto-load parameter (default: true)
      const autoLoad = urlParams.get('autoLoad');
      if (autoLoad !== 'false') {
        setTimeout(() => {
          loadWidget();
        }, 1000);
      }

      console.log('Configuration loaded from URL parameters');
    }

    // Auto-load widget on page load (unless autoLoad=false in URL)
    window.addEventListener('load', () => {
      loadConfigFromUrl();
    });
  </script>

  <!-- Widget will be loaded dynamically via the configuration section above -->

</body>
</html>
