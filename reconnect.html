<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Reconnect Scenarios - Power Pages Auth Demo</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
</head>
<body>
  <!-- Header with Navigation -->
  <header class="site-header">
    <div class="header-container">
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="support-auth.html">Support (Authenticated)</a>
        <a href="support-unauth.html">Support (Unauthenticated)</a>
        <a href="reconnect.html">Reconnect Scenarios</a>
      </nav>
      <div class="auth-section">
        <span class="user-info" id="user-info-text"></span>
        <button id="auth-button" class="auth-button" onclick="login()">Login</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container">
    <h1 class="page-title">Chat Reconnect Scenarios</h1>
    <p class="page-description">
      This page helps you test and understand different chat reconnection scenarios with authentication.
      Test how the widget behaves when users reconnect after logout, page refresh, or login during an active session.
    </p>

    <!-- Reconnect Scenarios Info -->
    <div class="info-box">
      <h3>Understanding Reconnect Scenarios</h3>
      <p>
        Chat widgets can reconnect to previous sessions using data stored in browser storage (localStorage).
        The reconnect behavior depends on whether the chat is authenticated or unauthenticated.
      </p>
      <p style="margin-top: 10px;">
        <strong>Default Widget on This Page:</strong> The reconnect test widget (App ID: 45b31cc0-54fa-4c39-ab97-c95e068f416b)
        behaves like an <strong>authenticated chat widget</strong> - it will clear chat context on logout.
      </p>
    </div>

    <!-- Scenario Cards -->
    <div class="card">
      <h2>ðŸ“‹ Scenario 1: Authenticated Chat Reconnect</h2>
      <p><strong>Widget Type:</strong> Authenticated Chat</p>
      <p><strong>Test Steps:</strong></p>
      <ol style="margin-left: 20px; line-height: 1.8;">
        <li>Login to your account</li>
        <li>Load the authenticated chat widget below</li>
        <li>Start a chat conversation</li>
        <li>Refresh the page (F5)</li>
        <li><strong>Expected:</strong> Chat should reconnect automatically while logged in</li>
        <li>Now click "Logout"</li>
        <li><strong>Expected:</strong> Chat context is cleared, cannot reconnect to same session</li>
      </ol>
      <div class="button-group" style="margin-top: 15px;">
        <button class="btn btn-primary" onclick="loadScenario1()">Load Authenticated Chat</button>
        <button class="btn btn-secondary" onclick="testReconnectScenario1()">Test Reconnect</button>
      </div>
    </div>

    <div class="card">
      <h2>ðŸ“‹ Scenario 2: Unauthenticated Chat Reconnect</h2>
      <p><strong>Widget Type:</strong> Unauthenticated Chat</p>
      <p><strong>Test Steps:</strong></p>
      <ol style="margin-left: 20px; line-height: 1.8;">
        <li>Load the unauthenticated chat widget below (no login required)</li>
        <li>Start an anonymous chat conversation</li>
        <li>Refresh the page (F5)</li>
        <li><strong>Expected:</strong> Chat should reconnect automatically</li>
        <li>Now login to your account</li>
        <li><strong>Expected:</strong> Chat remains connected, session continues (mid-auth applied)</li>
        <li>Now logout</li>
        <li><strong>Expected:</strong> Chat remains connected, can still reconnect to same anonymous session</li>
      </ol>
      <div class="button-group" style="margin-top: 15px;">
        <button class="btn btn-primary" onclick="loadScenario2()">Load Unauthenticated Chat</button>
        <button class="btn btn-secondary" onclick="testReconnectScenario2()">Test Reconnect</button>
      </div>
    </div>

    <div class="card">
      <h2>ðŸ“‹ Scenario 3: Mid-Authentication During Chat</h2>
      <p><strong>Widget Type:</strong> Authenticated Chat</p>
      <p><strong>Test Steps:</strong></p>
      <ol style="margin-left: 20px; line-height: 1.8;">
        <li>Ensure you are logged OUT</li>
        <li>Load the authenticated chat widget below</li>
        <li>Start a chat conversation (unauthenticated mode)</li>
        <li>While chat is active, click "Login"</li>
        <li><strong>Expected:</strong> After login redirect, widget reloads and calls setMidAuthToken()</li>
        <li><strong>Expected:</strong> Chat session is upgraded to authenticated mode</li>
      </ol>
      <div class="button-group" style="margin-top: 15px;">
        <button class="btn btn-primary" onclick="loadScenario3()">Load Authenticated Chat</button>
        <button class="btn btn-warning" onclick="clearAllChatStorage()">Clear All Chat Storage</button>
      </div>
    </div>

    <div class="card">
      <h2>ðŸ“‹ Scenario 4: Cross-Tab Session Sharing</h2>
      <p><strong>Widget Type:</strong> Both</p>
      <p><strong>Test Steps:</strong></p>
      <ol style="margin-left: 20px; line-height: 1.8;">
        <li>Open this page in Tab 1</li>
        <li>Load a chat widget and start a conversation</li>
        <li>Open the same page in Tab 2 (new tab)</li>
        <li>Load the same chat widget</li>
        <li><strong>Expected:</strong> Tab 2 should reconnect to the same chat session from Tab 1</li>
        <li>Close Tab 1, continue chatting in Tab 2</li>
        <li><strong>Expected:</strong> Chat continues seamlessly</li>
      </ol>
      <div class="button-group" style="margin-top: 15px;">
        <button class="btn btn-primary" onclick="window.open(window.location.href, '_blank')">Open in New Tab</button>
      </div>
    </div>

    <!-- Widget Configuration Section -->
    <div class="widget-config-section">
      <h2>Chat Widget Configuration</h2>

      <div class="info-box info">
        <strong>Current Mode:</strong> <span id="current-mode">None</span>
      </div>

      <div class="form-group">
        <label for="widget-appId">App ID:</label>
        <input type="text" id="widget-appId" value="45b31cc0-54fa-4c39-ab97-c95e068f416b">
      </div>

      <div class="form-group">
        <label for="widget-orgId">Org ID:</label>
        <input type="text" id="widget-orgId" value="1e9d7bbe-facf-f011-8537-000d3a59231e">
      </div>

      <div class="form-group">
        <label for="widget-orgUrl">Org URL:</label>
        <input type="text" id="widget-orgUrl" value="https://m-1e9d7bbe-facf-f011-8537-000d3a59231e.preprod.omnichannelengagementhub.com">
      </div>

      <div class="form-group">
        <label for="widget-scriptUrl">Script URL:</label>
        <input type="text" id="widget-scriptUrl" value="https://msft-lcw-trial.azureedge.net/jatinjdd/0123/v2scripts/LiveChatBootstrapper.js">
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="loadWidget()">Load Widget</button>
        <button class="btn btn-secondary" onclick="removeWidget()">Remove Widget</button>
        <button class="btn btn-warning" onclick="hardReload()">Remove & Clear Cache</button>
      </div>
    </div>

    <!-- Chat Storage Inspector -->
    <div class="widget-config-section">
      <h2>Chat Storage Inspector</h2>
      <p>View and manage chat-related data stored in your browser.</p>

      <div class="button-group">
        <button class="btn btn-primary" onclick="inspectChatStorage()">Inspect Storage</button>
        <button class="btn btn-danger" onclick="clearAllChatStorage()">Clear All Chat Storage</button>
      </div>

      <div id="storage-inspector" class="widget-status" style="display: none;">
        <h3>Storage Contents:</h3>
        <pre id="storage-inspector-text"></pre>
      </div>
    </div>

    <!-- Widget Status -->
    <div id="widget-status" class="widget-status">
      <h3>Widget Status:</h3>
      <pre id="widget-status-text"></pre>
    </div>

    <!-- User Info Display -->
    <div id="user-info" class="user-info-display" style="display: none;">
      <h3>Current User Information</h3>
      <pre id="user-info-json"></pre>
      <h3>Access Token (First 100 chars):</h3>
      <pre id="token-preview"></pre>
    </div>
  </main>

  <!-- Auth Script -->
  <script src="auth.js"></script>

  <!-- Widget Management Script -->
  <script>
    let widgetLoaded = false;
    let currentScenario = null;

    // Scenario configurations
    const scenarios = {
      authenticated: {
        appId: '1e27fef0-15f7-4202-bf85-f736d6c67735',
        name: 'Authenticated Chat'
      },
      unauthenticated: {
        appId: '50fbd2aa-1a19-475f-aeb6-59c8d15c8387',
        name: 'Unauthenticated Chat'
      },
      reconnect: {
        appId: '45b31cc0-54fa-4c39-ab97-c95e068f416b',
        name: 'Reconnect Test Chat'
      }
    };

    // Function to send mid-auth token to widget
    function sendMidAuthToken() {
      if (!widgetLoaded) {
        console.warn('[MidAuth] Widget is not loaded yet');
        return false;
      }

      const tokenToSend = pendingMidAuthToken || currentAccessToken;

      if (!tokenToSend || isTokenExpired()) {
        console.warn('[MidAuth] No valid access token available');
        return false;
      }

      try {
        if (window.Microsoft && window.Microsoft.Omnichannel &&
            window.Microsoft.Omnichannel.LiveChatWidget &&
            window.Microsoft.Omnichannel.LiveChatWidget.SDK) {

          console.log('[MidAuth] Calling Microsoft.Omnichannel.LiveChatWidget.SDK.setMidAuthToken()');
          console.log('[MidAuth] Token (first 50 chars):', tokenToSend.substring(0, 50) + '...');
          window.Microsoft.Omnichannel.LiveChatWidget.SDK.setMidAuthToken(tokenToSend);
          console.log('[MidAuth] âœ… Mid-auth token set successfully');

          // Clear pending token after successful send
          pendingMidAuthToken = null;
          return true;

        } else {
          console.error('[MidAuth] LiveChatWidget SDK not available');
          return false;
        }
      } catch (error) {
        console.error('[MidAuth] Error setting mid-auth token:', error);
        return false;
      }
    }

    function loadScenario1() {
      console.log('[Scenario] Loading Scenario 1: Authenticated Chat Reconnect');
      document.getElementById('widget-appId').value = scenarios.authenticated.appId;
      currentScenario = 'authenticated';
      document.getElementById('current-mode').textContent = scenarios.authenticated.name;
      loadWidget();
    }

    function loadScenario2() {
      console.log('[Scenario] Loading Scenario 2: Unauthenticated Chat Reconnect');
      document.getElementById('widget-appId').value = scenarios.unauthenticated.appId;
      currentScenario = 'unauthenticated';
      document.getElementById('current-mode').textContent = scenarios.unauthenticated.name;
      loadWidget();
    }

    function loadScenario3() {
      console.log('[Scenario] Loading Scenario 3: Mid-Authentication');
      document.getElementById('widget-appId').value = scenarios.authenticated.appId;
      currentScenario = 'mid-auth';
      document.getElementById('current-mode').textContent = 'Mid-Authentication Test';
      loadWidget();
    }

    function testReconnectScenario1() {
      if (!widgetLoaded) {
        alert('Please load the widget first!');
        return;
      }

      if (!isAuthenticated()) {
        alert('âš ï¸ Please login first to test authenticated chat reconnect!');
        return;
      }

      inspectChatStorage();
      alert('ðŸ“‹ Scenario 1 Test:\n\n1. Check the storage inspector below\n2. Refresh the page (F5)\n3. Widget should reconnect while logged in\n4. Logout and try refreshing again\n5. Widget should NOT reconnect (storage cleared)');
    }

    function testReconnectScenario2() {
      if (!widgetLoaded) {
        alert('Please load the widget first!');
        return;
      }

      inspectChatStorage();
      alert('ðŸ“‹ Scenario 2 Test:\n\n1. Check the storage inspector below\n2. Refresh the page (F5)\n3. Widget should reconnect\n4. Login/Logout and refresh again\n5. Widget should STILL reconnect (storage preserved)');
    }

    function inspectChatStorage() {
      const storageData = {
        localStorage: {},
        sessionStorage: {}
      };

      // Inspect localStorage
      try {
        const localStorageKeys = Object.keys(localStorage);
        localStorageKeys.forEach(key => {
          if (key.startsWith('oc-lcw-') ||
              key.includes('Omnichannel') ||
              key.includes('livechat') ||
              key.includes('reconnectId') ||
              key.includes('chatToken')) {
            storageData.localStorage[key] = localStorage.getItem(key).substring(0, 100) + '...';
          }
        });
      } catch (e) {
        storageData.localStorage.error = e.message;
      }

      // Inspect sessionStorage
      try {
        const sessionStorageKeys = Object.keys(sessionStorage);
        sessionStorageKeys.forEach(key => {
          if (key.startsWith('oc-lcw-') ||
              key.includes('Omnichannel') ||
              key.includes('livechat') ||
              key.includes('reconnectId') ||
              key.includes('chatToken')) {
            storageData.sessionStorage[key] = sessionStorage.getItem(key).substring(0, 100) + '...';
          }
        });
      } catch (e) {
        storageData.sessionStorage.error = e.message;
      }

      // Display
      const inspectorDiv = document.getElementById('storage-inspector');
      const inspectorText = document.getElementById('storage-inspector-text');

      if (inspectorDiv && inspectorText) {
        inspectorDiv.style.display = 'block';
        inspectorText.textContent = JSON.stringify(storageData, null, 2);
      }

      console.log('[Storage Inspector]', storageData);
    }

    function clearAllChatStorage() {
      if (!confirm('Are you sure you want to clear all chat storage? This will disconnect any active sessions.')) {
        return;
      }

      console.log('[Storage] Clearing all chat storage...');

      // Clear localStorage
      try {
        const localStorageKeys = Object.keys(localStorage);
        let clearedCount = 0;
        localStorageKeys.forEach(key => {
          if (key.startsWith('oc-lcw-') ||
              key.includes('Omnichannel') ||
              key.includes('livechat') ||
              key.includes('reconnectId') ||
              key.includes('chatToken')) {
            localStorage.removeItem(key);
            clearedCount++;
          }
        });
        console.log(`[Storage] Cleared ${clearedCount} localStorage items`);
      } catch (e) {
        console.warn('[Storage] Could not clear localStorage:', e);
      }

      // Clear sessionStorage
      try {
        const sessionStorageKeys = Object.keys(sessionStorage);
        let clearedCount = 0;
        sessionStorageKeys.forEach(key => {
          if (key.startsWith('oc-lcw-') ||
              key.includes('Omnichannel') ||
              key.includes('livechat') ||
              key.includes('reconnectId') ||
              key.includes('chatToken')) {
            sessionStorage.removeItem(key);
            clearedCount++;
          }
        });
        console.log(`[Storage] Cleared ${clearedCount} sessionStorage items`);
      } catch (e) {
        console.warn('[Storage] Could not clear sessionStorage:', e);
      }

      alert('âœ… All chat storage cleared! Refresh the page to start fresh.');
      inspectChatStorage();
    }

    function loadWidget() {
      const appId = document.getElementById('widget-appId').value;
      const orgId = document.getElementById('widget-orgId').value;
      const orgUrl = document.getElementById('widget-orgUrl').value;
      const scriptUrl = document.getElementById('widget-scriptUrl').value;

      console.log('[Widget] loadWidget() called with:', { appId, orgId, orgUrl, scriptUrl });

      // Validate inputs
      if (!appId || !orgId || !orgUrl || !scriptUrl) {
        showWidgetStatus('All fields are required');
        console.error('[Widget] Validation failed - missing required fields');
        return;
      }

      // Check if already loaded
      if (widgetLoaded) {
        showWidgetStatus('Widget is already loaded. Remove it first to reload.');
        return;
      }

      // Create script element with standard ID
      const script = document.createElement('script');
      script.id = 'Microsoft_Omnichannel_LCWidget';

      // Set all data attributes BEFORE setting src
      script.setAttribute('data-app-id', appId);
      script.setAttribute('data-lcw-version', 'test');
      script.setAttribute('data-org-id', orgId);
      script.setAttribute('data-org-url', orgUrl);

      console.log('[Widget] Script element created with ID:', script.id);

      // Set src LAST with cache-busting parameter
      const cacheBuster = new Date().getTime();
      const separator = scriptUrl.includes('?') ? '&' : '?';
      script.src = scriptUrl + separator + 'cb=' + cacheBuster;

      console.log('[Widget] Widget script URL with cache-buster:', script.src);

      // Add to document
      document.body.appendChild(script);
      widgetLoaded = true;

      console.log('[Widget] Widget loaded successfully');
      showWidgetStatus(`Widget loaded successfully!\nApp ID: ${appId}\nOrg ID: ${orgId}\nScenario: ${currentScenario || 'Manual'}`);

      // Set up mid-auth token listener
      setupMidAuthTokenListener();

      // Save configuration
      saveCurrentFormValues();

      // Inspect storage after a delay
      setTimeout(() => {
        inspectChatStorage();
      }, 2000);
    }

    function setupMidAuthTokenListener() {
      console.log('[MidAuth] Setting up event listeners...');

      // Listen for lcw:ready event
      window.addEventListener('lcw:ready', function() {
        console.log('[MidAuth] lcw:ready event received - widget is ready');

        // Wait for widget to restore chat, then send token if available
        if (pendingMidAuthToken && !isTokenExpired()) {
          console.log('[MidAuth] Pending token detected - waiting for chat restoration...');

          setTimeout(() => {
            console.log('[MidAuth] Sending pending token after restoration delay...');
            const success = sendMidAuthToken();

            if (success) {
              console.log('[MidAuth] âœ… Token sent - should trigger mid-auth!');
              alert('âœ… Authentication successful! Your chat is now authenticated.');
              chatRestored = true;
            } else {
              console.error('[MidAuth] âŒ Failed to send token');
            }
          }, 3000);
        } else if (currentAccessToken && !isTokenExpired()) {
          // User was already logged in when widget loaded
          console.log('[MidAuth] User already logged in - setting up token for existing chat');
          pendingMidAuthToken = currentAccessToken;

          setTimeout(() => {
            console.log('[MidAuth] Sending token for existing authenticated user...');
            sendMidAuthToken();
            chatRestored = true;
          }, 3000);
        } else {
          console.log('[MidAuth] No valid token available - widget will work in unauthenticated mode');
        }
      });

      console.log('[MidAuth] Event listeners registered');
    }

    function removeWidget() {
      const script = document.getElementById('Microsoft_Omnichannel_LCWidget');

      console.log('[Widget] Removing widget...');

      // Remove all iframes
      const iframes = document.querySelectorAll('iframe');
      iframes.forEach(iframe => {
        if (iframe.src && (iframe.src.includes('omnichannelengagementhub') ||
            iframe.src.includes('livechat') ||
            iframe.src.includes('lcw') ||
            iframe.id.includes('lcw') ||
            iframe.className.includes('lcw'))) {
          console.log('[Widget] Removing widget iframe:', iframe.src);
          iframe.remove();
        }
      });

      // Remove all widget-related DOM elements
      const ocElements = document.querySelectorAll('[class*="oc-lcw"], [id*="oc-lcw"]');
      ocElements.forEach(el => el.remove());

      const omnichannelElements = document.querySelectorAll('[class*="microsoft-omnichannel"], [id*="microsoft-omnichannel"]');
      omnichannelElements.forEach(el => el.remove());

      // Remove the script element
      if (script) {
        script.remove();
        console.log('[Widget] Widget script removed');
      }

      // Clean up global window objects
      try {
        if (window.Microsoft && window.Microsoft.Omnichannel) {
          delete window.Microsoft.Omnichannel.LiveChatWidget;
        }
        if (window.Microsoft && window.Microsoft.Omnichannel && Object.keys(window.Microsoft.Omnichannel).length === 0) {
          delete window.Microsoft.Omnichannel;
        }
        if (window.Microsoft && Object.keys(window.Microsoft).length === 0) {
          delete window.Microsoft;
        }
      } catch (e) {
        console.warn('[Widget] Could not clean up global objects:', e);
      }

      widgetLoaded = false;
      chatRestored = false;
      pendingMidAuthToken = null;
      currentScenario = null;
      document.getElementById('current-mode').textContent = 'None';
      showWidgetStatus('Widget removed successfully. Storage remains intact for reconnect testing.');
      console.log('[Widget] Widget removed (storage preserved)');
    }

    async function hardReload() {
      console.log('[Widget] Performing hard reload with cache clear...');

      // Save current form values
      saveCurrentFormValues();

      // Remove widget first
      removeWidget();

      // Clear all chat storage
      clearAllChatStorage();

      // Clear all caches
      if ('caches' in window) {
        try {
          const cacheNames = await caches.keys();
          console.log('[Widget] Clearing', cacheNames.length, 'cache(s)');
          await Promise.all(cacheNames.map(cacheName => caches.delete(cacheName)));
          console.log('[Widget] All service worker caches cleared');
        } catch (e) {
          console.warn('[Widget] Could not clear service worker caches:', e);
        }
      }

      // Hard reload after a short delay
      setTimeout(() => {
        console.log('[Widget] Performing hard reload');
        window.location.reload(true);
      }, 500);
    }

    function showWidgetStatus(message) {
      const statusDiv = document.getElementById('widget-status');
      const statusText = document.getElementById('widget-status-text');

      if (statusDiv && statusText) {
        statusDiv.classList.add('show');
        statusText.textContent = message;

        // Auto-hide after 8 seconds (longer for this page)
        setTimeout(() => {
          statusDiv.classList.remove('show');
        }, 8000);
      }
    }

    function saveCurrentFormValues() {
      const formData = {
        appId: document.getElementById('widget-appId').value,
        orgId: document.getElementById('widget-orgId').value,
        orgUrl: document.getElementById('widget-orgUrl').value,
        scriptUrl: document.getElementById('widget-scriptUrl').value,
        scenario: currentScenario
      };
      localStorage.setItem('widget-config-reconnect', JSON.stringify(formData));
      console.log('[Widget] Form values saved to localStorage');
    }

    function restoreSavedConfig() {
      const savedConfig = localStorage.getItem('widget-config-reconnect');
      if (savedConfig) {
        try {
          const formData = JSON.parse(savedConfig);
          console.log('[Widget] Restoring form values from saved config');

          document.getElementById('widget-appId').value = formData.appId;
          document.getElementById('widget-orgId').value = formData.orgId;
          document.getElementById('widget-orgUrl').value = formData.orgUrl;
          document.getElementById('widget-scriptUrl').value = formData.scriptUrl;
          currentScenario = formData.scenario || null;

          if (currentScenario) {
            const scenarioName = scenarios[currentScenario]?.name || currentScenario;
            document.getElementById('current-mode').textContent = scenarioName;
          }

          console.log('[Widget] Form values restored successfully');
        } catch (e) {
          console.error('[Widget] Could not restore saved config:', e);
        }
      }
    }

    function setupFormAutoSave() {
      const inputs = ['widget-appId', 'widget-orgId', 'widget-orgUrl', 'widget-scriptUrl'];
      inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.addEventListener('change', saveCurrentFormValues);
          input.addEventListener('input', saveCurrentFormValues);
        }
      });
      console.log('[Widget] Form auto-save enabled');
    }

    // Display user info if authenticated
    document.addEventListener('DOMContentLoaded', () => {
      // Restore saved config
      restoreSavedConfig();
      setupFormAutoSave();

      // Check auth state and display user info
      setTimeout(() => {
        const user = getCurrentUser();
        if (user) {
          const userInfoDiv = document.getElementById('user-info');
          const userInfoJson = document.getElementById('user-info-json');
          const tokenPreview = document.getElementById('token-preview');

          if (userInfoDiv && userInfoJson) {
            userInfoDiv.style.display = 'block';
            userInfoJson.textContent = JSON.stringify(user, null, 2);

            if (tokenPreview && currentAccessToken) {
              tokenPreview.textContent = currentAccessToken.substring(0, 100) + '...';
            }
          }
        }
      }, 500);
    });

    // Save form values before page unload
    window.addEventListener('beforeunload', () => {
      saveCurrentFormValues();
    });

    // Listen for logout event - clear chat context for authenticated scenarios
    window.addEventListener('auth:logout', function(event) {
      console.log('[Reconnect Page] Logout detected - scenario:', currentScenario);

      // For reconnect testing, we treat the default widget and authenticated scenarios the same
      // They both clear chat context on logout (similar to authenticated chat behavior)
      if (currentScenario === 'authenticated' || currentScenario === 'mid-auth' || !currentScenario) {
        console.log('[Reconnect Page] Clearing chat context (authenticated behavior)');

        // Clear chat storage
        try {
          const localStorageKeys = Object.keys(localStorage);
          let clearedCount = 0;
          localStorageKeys.forEach(key => {
            if (key.startsWith('oc-lcw-') ||
                key.includes('Omnichannel') ||
                key.includes('livechat') ||
                key.includes('reconnectId') ||
                key.includes('chatToken')) {
              localStorage.removeItem(key);
              clearedCount++;
            }
          });
          console.log(`[Reconnect Page] Cleared ${clearedCount} localStorage items`);
        } catch (e) {
          console.warn('[Reconnect Page] Could not clear localStorage:', e);
        }

        // Clear sessionStorage
        try {
          const sessionStorageKeys = Object.keys(sessionStorage);
          sessionStorageKeys.forEach(key => {
            if (key.startsWith('oc-lcw-') ||
                key.includes('Omnichannel') ||
                key.includes('livechat') ||
                key.includes('reconnectId') ||
                key.includes('chatToken')) {
              sessionStorage.removeItem(key);
            }
          });
        } catch (e) {
          console.warn('[Reconnect Page] Could not clear sessionStorage:', e);
        }
      } else if (currentScenario === 'unauthenticated') {
        console.log('[Reconnect Page] Preserving unauthenticated chat context');
        // Do not clear storage for unauthenticated scenario testing
      }
    });
  </script>
</body>
</html>
