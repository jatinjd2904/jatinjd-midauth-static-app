<!DOCTYPE html>
<html>
<head>
  <title>Jatin Mid Auth Test (MSAL)</title>
  <!-- MSAL.js library -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
</head>
<body>
  <h1>Jatin App Auth Test (MSAL Direct Auth)</h1>

  <!-- Auth buttons -->
  <button onclick="login()">Sign in with Azure AD</button>
  <button onclick="logout()">Sign out</button>

  <pre id="user"></pre>

  <!-- Chat Widget Configuration Section -->
  <hr style="margin: 30px 0;">
  <h2>Configure Chat Widgets</h2>
  <div style="background: #f5f5f5; padding: 20px; margin-bottom: 20px;">
    <h3>Widget 1 (MidAuth Chat Widget)</h3>
    <form id="widget1-config">
      <label>App ID: <input type="text" id="widget1-appId" value="9c155eb8-61cc-41ff-9433-16355ce73ed2" style="width: 300px;"></label><br><br>
      <label>Org ID: <input type="text" id="widget1-orgId" value="1e9d7bbe-facf-f011-8537-000d3a59231e" style="width: 300px;"></label><br><br>
      <label>Org URL: <input type="text" id="widget1-orgUrl" value="https://m-1e9d7bbe-facf-f011-8537-000d3a59231e.preprod.omnichannelengagementhub.com" style="width: 500px;"></label><br><br>
      <label>Script URL: <input type="text" id="widget1-scriptUrl" value="https://msft-lcw-trial.azureedge.net/jatinjdd/0123/v2scripts/LiveChatBootstrapper.js" style="width: 500px;"></label><br><br>
      <button type="button" onclick="loadWidget(1)">Load Widget 1</button>
      <button type="button" onclick="removeWidget(1)">Remove Widget 1</button>
    </form>
  </div>

  <div style="background: #f5f5f5; padding: 20px; margin-bottom: 20px;">
    <h3>Widget 2 (UnAuth Chat)</h3>
    <form id="widget2-config">
      <label>App ID: <input type="text" id="widget2-appId" value="50fbd2aa-1a19-475f-aeb6-59c8d15c8387" style="width: 300px;"></label><br><br>
      <label>Org ID: <input type="text" id="widget2-orgId" value="1e9d7bbe-facf-f011-8537-000d3a59231e" style="width: 300px;"></label><br><br>
      <label>Org URL: <input type="text" id="widget2-orgUrl" value="https://m-1e9d7bbe-facf-f011-8537-000d3a59231e.preprod.omnichannelengagementhub.com" style="width: 500px;"></label><br><br>
      <label>Script URL: <input type="text" id="widget2-scriptUrl" value="https://msft-lcw-trial.azureedge.net/jatinjdd/0123/v2scripts/LiveChatBootstrapper.js" style="width: 500px;"></label><br><br>
      <button type="button" onclick="loadWidget(2)">Load Widget 2</button>
      <button type="button" onclick="removeWidget(2)">Remove Widget 2</button>
    </form>
  </div>

  <div id="widget-status" style="background: #e8f5e9; padding: 15px; margin-bottom: 20px; display: none;">
    <h3>Widget Status:</h3>
    <pre id="widget-status-text"></pre>
  </div>
  <hr style="margin: 30px 0;">

  <script>
    // MSAL Configuration - YOU NEED TO UPDATE THESE VALUES
    const msalConfig = {
      auth: {
        clientId: "b0565fdb-6754-40e3-9446-72afdf056f0b",
        authority: "https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47",
        redirectUri: window.location.origin + "/index.html"
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false
      }
    };

    // Scopes for token request - Request token for this application
    // Using GUID-based identifier (required when app requests token for itself)
    const tokenRequest = {
      scopes: ["b0565fdb-6754-40e3-9446-72afdf056f0b/.default"]
    };

    // Initialize MSAL
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    // Store the access token and expiration time globally
    let currentAccessToken = null;
    let tokenExpiresOn = null;

    // Check if token is expired or will expire soon (within 5 minutes)
    function isTokenExpired() {
      if (!tokenExpiresOn) return true;
      const now = new Date();
      const expiryTime = new Date(tokenExpiresOn);
      const timeUntilExpiry = expiryTime - now;
      const fiveMinutes = 5 * 60 * 1000; // 5 minutes in milliseconds
      return timeUntilExpiry < fiveMinutes;
    }

    // Refresh the access token
    async function refreshToken() {
      console.log('ðŸ”„ Refreshing access token...');
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length === 0) {
        console.error('No accounts found for token refresh');
        return null;
      }

      const request = {
        ...tokenRequest,
        account: accounts[0]
      };

      try {
        const response = await msalInstance.acquireTokenSilent(request);
        currentAccessToken = response.accessToken;
        tokenExpiresOn = response.expiresOn;
        console.log('âœ… Token refreshed successfully');
        console.log('New token expires:', new Date(tokenExpiresOn));
        return currentAccessToken;
      } catch (error) {
        console.error('Token refresh failed:', error);
        // Fall back to interactive redirect
        await msalInstance.acquireTokenRedirect(request);
        return null;
      }
    }

    // Define window.auth.getAuthenticationToken for Omnichannel authenticated chat
    window.auth = {};
    window.auth.getAuthenticationToken = async function(callback) {
      console.log('window.auth.getAuthenticationToken() called by Omnichannel widget');

      try {
        // Check if token exists and is valid
        if (currentAccessToken && !isTokenExpired()) {
          console.log('âœ… Returning cached AAD access token:', currentAccessToken);
          callback(currentAccessToken);
        } else if (currentAccessToken && isTokenExpired()) {
          // Token exists but is expired or expiring soon - refresh it
          console.log('âš ï¸ Token expired or expiring soon, refreshing...');
          const newToken = await refreshToken();
          if (newToken) {
            callback(newToken);
          } else {
            console.error('âŒ Token refresh failed');
            callback(null);
          }
        } else {
          console.error('âŒ No access token available. User may not be logged in.');
          callback(null);
        }
      } catch (error) {
        console.error('Error in getAuthenticationToken:', error);
        callback(null);
      }
    };

    // Login function
    async function login() {
      try {
        console.log('Initiating MSAL login redirect...');
        await msalInstance.loginRedirect(tokenRequest);
      } catch (error) {
        console.error('Login failed:', error);
        alert('Login failed: ' + error.message);
      }
    }

    // Get access token
    async function getToken() {
      const accounts = msalInstance.getAllAccounts();
      if (accounts.length === 0) {
        console.error('No accounts found');
        return;
      }

      const request = {
        ...tokenRequest,
        account: accounts[0]
      };

      try {
        // Try to get token silently
        const response = await msalInstance.acquireTokenSilent(request);
        currentAccessToken = response.accessToken;
        tokenExpiresOn = response.expiresOn;

        console.log('âœ… AAD Access Token acquired:', currentAccessToken);
        console.log('Token length:', currentAccessToken.length);
        console.log('Token expires:', new Date(tokenExpiresOn));

        // Display user info
        displayUserInfo(response.account, currentAccessToken);

        // Test the getAuthenticationToken function
        setTimeout(function() {
          console.log('Testing window.auth.getAuthenticationToken...');
          window.auth.getAuthenticationToken(function(token) {
            if (token) {
              console.log('âœ… Test successful - Token retrieved:', token);
            } else {
              console.error('âŒ Test failed: No token returned');
            }
          });
        }, 500);

      } catch (error) {
        console.error('Silent token acquisition failed, using redirect:', error);

        // Fall back to interactive redirect method
        await msalInstance.acquireTokenRedirect(request);
      }
    }

    // Display user info
    function displayUserInfo(account, token) {
      const userInfo = {
        username: account.username,
        name: account.name,
        accountId: account.homeAccountId,
        tenantId: account.tenantId
      };

      document.getElementById("user").innerHTML =
        '<h3>User Info:</h3><pre style="background:#e8f5e9;padding:10px;">' +
        JSON.stringify(userInfo, null, 2) +
        '</pre>' +
        '<h3>Access Token (Real AAD JWT):</h3><pre style="background:#f0f0f0;padding:10px;word-wrap:break-word;font-size:11px;">' +
        token +
        '</pre>';
    }

    // Logout function
    function logout() {
      currentAccessToken = null;
      tokenExpiresOn = null;
      const logoutRequest = {
        account: msalInstance.getAllAccounts()[0]
      };
      msalInstance.logoutRedirect(logoutRequest);
    }

    // Check if user is already logged in on page load
    msalInstance.handleRedirectPromise()
      .then(response => {
        if (response) {
          console.log('Redirect response:', response);
          console.log('Login successful via redirect');
          // Token is in the response
          currentAccessToken = response.accessToken;
          tokenExpiresOn = response.expiresOn;
          console.log('âœ… AAD Access Token acquired:', currentAccessToken);
          console.log('Token length:', currentAccessToken.length);
          console.log('Token expires:', new Date(tokenExpiresOn));
          displayUserInfo(response.account, currentAccessToken);

          // Test the getAuthenticationToken function
          setTimeout(function() {
            console.log('Testing window.auth.getAuthenticationToken...');
            window.auth.getAuthenticationToken(function(token) {
              if (token) {
                console.log('âœ… Test successful - Token retrieved:', token);
              } else {
                console.error('âŒ Test failed: No token returned');
              }
            });
          }, 500);
        } else {
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length > 0) {
            console.log('User already logged in');
            getToken();
          }
        }
      })
      .catch(error => {
        console.error('Error handling redirect:', error);
      });

    // Widget Management Functions
    const loadedWidgets = new Set();

    function loadWidget(widgetNumber) {
      const appId = document.getElementById(`widget${widgetNumber}-appId`).value;
      const orgId = document.getElementById(`widget${widgetNumber}-orgId`).value;
      const orgUrl = document.getElementById(`widget${widgetNumber}-orgUrl`).value;
      const scriptUrl = document.getElementById(`widget${widgetNumber}-scriptUrl`).value;

      console.log(`ðŸ” loadWidget(${widgetNumber}) called with:`, { appId, orgId, orgUrl, scriptUrl });

      // Validate inputs
      if (!appId || !orgId || !orgUrl || !scriptUrl) {
        showWidgetStatus(`âŒ Widget ${widgetNumber}: All fields are required`);
        console.error(`âŒ Validation failed for widget ${widgetNumber}`);
        return;
      }

      // Check if already loaded
      if (loadedWidgets.has(widgetNumber)) {
        showWidgetStatus(`âš ï¸ Widget ${widgetNumber} is already loaded. Remove it first to reload.`);
        return;
      }

      // Create script element - use standard ID for first widget, numbered for others
      const script = document.createElement('script');
      // LiveChatBootstrapper expects ID to be exactly "Microsoft_Omnichannel_LCWidget" for the primary widget
      script.id = widgetNumber === 1 ? 'Microsoft_Omnichannel_LCWidget' : `Microsoft_Omnichannel_LCWidget_${widgetNumber}`;

      // IMPORTANT: Set all data attributes BEFORE setting src
      // This ensures attributes are available when the script loads
      script.setAttribute('data-app-id', appId);
      script.setAttribute('data-lcw-version', 'test');
      script.setAttribute('data-org-id', orgId);
      script.setAttribute('data-org-url', orgUrl);

      console.log(`ðŸ“ Script element created with ID: ${script.id}`);
      console.log(`ðŸ“ Data attributes set:`, {
        'data-app-id': script.getAttribute('data-app-id'),
        'data-org-id': script.getAttribute('data-org-id'),
        'data-org-url': script.getAttribute('data-org-url'),
        'data-lcw-version': script.getAttribute('data-lcw-version')
      });

      // Set src LAST to trigger loading only after all attributes are set
      script.src = scriptUrl;

      // Add to document
      document.body.appendChild(script);
      loadedWidgets.add(widgetNumber);

      console.log(`âœ… Widget ${widgetNumber} script appended to document body`);
      console.log(`âœ… Widget ${widgetNumber} loaded:`, { appId, orgId, orgUrl });
      showWidgetStatus(`âœ… Widget ${widgetNumber} loaded successfully!\nApp ID: ${appId}\nOrg ID: ${orgId}`);
    }

    function removeWidget(widgetNumber) {
      const scriptId = widgetNumber === 1 ? 'Microsoft_Omnichannel_LCWidget' : `Microsoft_Omnichannel_LCWidget_${widgetNumber}`;
      const script = document.getElementById(scriptId);

      if (script) {
        script.remove();
        loadedWidgets.delete(widgetNumber);
        console.log(`ðŸ—‘ï¸ Widget ${widgetNumber} script removed`);

        // Remove all widget-related DOM elements
        const chatButton = document.querySelector('.oc-lcw-chat-button');
        if (chatButton) {
          chatButton.remove();
          console.log('ðŸ—‘ï¸ Chat button removed');
        }

        // Remove chat iframe if it exists
        const chatIframe = document.querySelector('iframe[id*="oc-lcw"]');
        if (chatIframe) {
          chatIframe.remove();
          console.log('ðŸ—‘ï¸ Chat iframe removed');
        }

        // Remove minimized chat icon
        const minimizedIcon = document.querySelector('.oc-lcw-minimized-icon');
        if (minimizedIcon) {
          minimizedIcon.remove();
          console.log('ðŸ—‘ï¸ Minimized icon removed');
        }

        showWidgetStatus(`ðŸ—‘ï¸ Widget ${widgetNumber} removed successfully`);
      } else {
        showWidgetStatus(`âš ï¸ Widget ${widgetNumber} is not currently loaded`);
        console.warn(`âš ï¸ Script element with ID "${scriptId}" not found`);
      }
    }

    function showWidgetStatus(message) {
      const statusDiv = document.getElementById('widget-status');
      const statusText = document.getElementById('widget-status-text');
      statusDiv.style.display = 'block';
      statusText.textContent = message;

      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    // Parse URL parameters and populate widget configuration
    function loadConfigFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);

      // Widget 1 parameters
      if (urlParams.has('w1_appId')) {
        document.getElementById('widget1-appId').value = urlParams.get('w1_appId');
      }
      if (urlParams.has('w1_orgId')) {
        document.getElementById('widget1-orgId').value = urlParams.get('w1_orgId');
      }
      if (urlParams.has('w1_orgUrl')) {
        document.getElementById('widget1-orgUrl').value = urlParams.get('w1_orgUrl');
      }
      if (urlParams.has('w1_scriptUrl')) {
        document.getElementById('widget1-scriptUrl').value = urlParams.get('w1_scriptUrl');
      }

      // Widget 2 parameters
      if (urlParams.has('w2_appId')) {
        document.getElementById('widget2-appId').value = urlParams.get('w2_appId');
      }
      if (urlParams.has('w2_orgId')) {
        document.getElementById('widget2-orgId').value = urlParams.get('w2_orgId');
      }
      if (urlParams.has('w2_orgUrl')) {
        document.getElementById('widget2-orgUrl').value = urlParams.get('w2_orgUrl');
      }
      if (urlParams.has('w2_scriptUrl')) {
        document.getElementById('widget2-scriptUrl').value = urlParams.get('w2_scriptUrl');
      }

      // Auto-load parameter (default: true for widget 1)
      const autoLoad = urlParams.get('autoLoad');
      if (autoLoad !== 'false') {
        setTimeout(() => {
          loadWidget(1);
        }, 1000);
      }

      console.log('ðŸ“‹ Configuration loaded from URL parameters');
    }

    // Auto-load Widget 1 on page load (unless autoLoad=false in URL)
    window.addEventListener('load', () => {
      loadConfigFromUrl();
    });
  </script>

  <!-- Widgets will be loaded dynamically via the configuration section above -->
  <!-- Static widget loading disabled - use the configuration section to load widgets dynamically -->

</body>
</html>
